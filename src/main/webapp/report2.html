<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="style.css">
<style>

svg {
  font: 10px sans-serif;
}

.subBar { 
  fill: gray;
  opacity: 0.5;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.brush .extent {
  stroke: #fff;
  fill: steelblue;
  fill-opacity: .25;
  shape-rendering: crispEdges;
}

</style>
<body>
    <div id = "nav-bar"> 
        </div>
        <div id="heading-content"> 
            <h1 id="heading">Computation Visualizer</h1>
        </div>
        <div id="container">
            <div id="element"></div>
        </div>
        <form action="#">
            <label for="uploaded-files">Choose a file: </label>
            <select id="uploaded-files" name="uploaded-files"></select>
        </form>
        <form action='#' onsubmit="runVisualization()">
            <input type="submit" value="Run!" />
        </form>
        <div id="test-box">
        </div>
    <p id="chart"></p>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script>
  
var data = [];
 
for (var i = 0; i < 1400; i++) {
  var datum = {};
  datum.location = i;
  datum.layer= i%23;
  data.push(datum);
} 
for (var i = 0; i < 10; i++) {
  var datum = {};
  datum.location = 5;
  datum.layer= i%23;
  data.push(datum);
} 


var obj = document.getElementById('chart'); 
var divWidth = obj.offsetWidth;  
var margin = {top: 10, right: 10, bottom: 100, left: 40},
    margin2 = {top: 430, right: 10, bottom: 20, left: 40},
    width = divWidth - 25,
    height = 500 - margin.top - margin.bottom,
    height2 = 500 - margin2.top - margin2.bottom;

var x = d3.scale.ordinal().rangeBands([0, width], 0),
    x2 = d3.scale.ordinal().rangeBands([0, width], 0),
   // y = d3.scale.linear().range([height, 0], 0),
     y = d3.scale.ordinal().rangeRoundBands([0, height], 0),
    y2 = d3.scale.linear().domain([1400,0]).range([height2, 0]),
   // y2 = d3.scale.ordinal().rangeBands([height2, 0], 0).domain([1400,0]),
    colorScale = d3.scale.ordinal().domain([0, d3.max(data, function(d) { return d.layer;})]).range(['#FF5714', '#ccc', '#1BE7FF']);

var xAxis = d3.svg.axis().scale(x).orient("bottom"),
    xAxis2 = d3.svg.axis().scale(x2).orient("bottom").tickValues([]),
    yAxis = d3.svg.axis().scale(y).orient("left");

	x.domain(data.map(function(d){ return d.location}));
	y.domain(data.map(function(d){ return d.layer}));
  	x2.domain(x.domain());
	
    
		
  //add brush
  var brush = d3.svg.brush()
			.x(x2) 
			.on("brush", brushed);
  

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

var focus = svg.append("g")
    .attr("class", "focus")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
var context = svg.append("g")
    .attr("class", "context")
    .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

  focus.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  focus.append("g")
      .attr("class", "y axis")
      .call(yAxis);
	 
  console.log(x(data[0].location))
 	enter(data)
  updateScale(data)
  
  var subBars = context.selectAll('.subBar')
                                  	.data(data)
	
  subBars.enter().append("rect")
		  .classed('subBar', true)
          
			.attr(
    	{
        height: function (d)
        {
         return  10;
        },
        width: function(d){ return x.rangeBand()},
        x: function(d) {
          return x2(d.location);
        },
        y: function(d)
        {
          return y2(d.layer) - 10
        }
      })

  context.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height2 + ")")
      .call(xAxis2);

  context.append("g")
      .attr("class", "x brush")
      .call(brush)
    .selectAll("rect")
      .attr("y", -10)
      .attr("height",  50);
      //.attr("height", height2 + 7);

function brushed() {
    var selected = null; 
      selected =  x2.domain()
                .filter(function(d){
                 		return (brush.extent()[0] <= x2(d)) && (x2(d) <= brush.extent()[1]);
							});
  
    var start;
    var end;
		
  	if(brush.extent()[0] != brush.extent()[1])
      {
        start = selected[0];
		end = selected[selected.length - 1] + 1;
      } 
      else { 
		start = 0;
		end = data.length;
      }

    var updatedData = data.slice(start, end);

    update(updatedData);
    enter(updatedData);
    exit(updatedData);
  	updateScale(updatedData)

}
 
  function updateScale(data)
  { 
    var tickScale = d3.scale.pow().range([data.length / 10, 0]).domain([data.length, 0]).exponent(.5)
    var brushValue = brush.extent()[1] - brush.extent()[0];
    if(brushValue === 0){
      brushValue = width;
    }

    var tickValueMultiplier = Math.ceil(Math.abs(tickScale(brushValue)));  
  	var filteredTickValues = data.filter(function(d, i){return i % tickValueMultiplier === 0}).map(function(d){ return d.location})
    focus.select(".x.axis").call(xAxis.tickValues(filteredTickValues));
    //focus.select(".y.axis").call(yAxis);
  }
  
  function update(data)
  {
		  x.domain(data.map(function(d){ return d.location}));
		  //y.domain([0, 23]);
          y.domain(data.map(function(d){ return d.layer}));

      var bars =  focus.selectAll('.bar')
          .data(data)
      bars
        .attr(
        {  
          height: function (d, i)
          { 
            if (data.length < 23){
                var newHeight = (27 * data.length)/15
                return newHeight;
            }
           
            return 20;
          },
          width: function(d){ 
            return x.rangeBand()
          },
          x: function(d) {

            return x(d.location);
          },
          y: function(d)
          {
            console.log(y(d.layer));
           return 379 - y(d.layer)
           //return y(d.layer);
          },
          fill: function(d)
          {
              return colorScale(d.layer);
          }
        })


  } 
  
  function colorPicker(v) {
  if (v % 2 === 0) {
    return "#666666";
  } else {
    return "#FF0033";
  }
}

  function exit(data)
  {
		var bars =  focus.selectAll('.bar').data(data)
		bars.exit().remove()
  }
  
  function enter(data)
  {
      console.log(data.length);
    	x.domain(data.map(function(d){ return d.location}));
		//y.domain([0, d3.max(data, function(d) { return d.layer;})]);
        y.domain(data.map(function(d){ return d.layer}));

      var bars =  focus.selectAll('.bar')
          .data(data)
      bars.enter().append("rect")
      .style("stroke-linejoin", "round")
        .classed('bar', true)
        .attr(
        {  
          height: function (d, i)
          { 
            var newHeight = (3 * data.length)/280
            return newHeight;
          },
          width: function(d){ 
            return x.rangeBand()
          },
          x: function(d) {
 
            return x(d.location);
          },
          y: function(d)
          {
            return 379 - y(d.layer) 
          },
          fill: function(d)
          {
              return colorScale(d.layer);
          },
          stroke: function(d)
          {
              return colorScale(d.layer);
          } 
        }) 
  }

</script>